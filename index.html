<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content='"Is it nothing to you, all ye that pass by? behold, and see if there be any sorrow like unto my sorrow"'>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lamentations</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="http://perryjer1.github.io/">
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
    },
    displayAlign: 'left', // Change this to 'center' to center equations.
    "HTML-CSS": {
        styles: {'.MathJax_Display': {"margin": 0}}
    }
});
</script><!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/r-tip-devoff/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://perryjer1.github.io/">

                <span id="blog-title">Lamentations</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="archive.html">Archive</a>
                </li>
<li>
<a href="categories/">Tags</a>
                </li>
<li>
<a href="rss.xml">RSS feed</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    
<div class="postindex">
    <article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/r-tip-devoff/" class="u-url">R tip: dev.off()</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Jeremiah Perry
            </span></p>
            <p class="dateline"><a href="posts/r-tip-devoff/" rel="bookmark"><time class="published dt-published" datetime="2017-05-19T08:13:44-05:00" title="2017-05-19 08:13">2017-05-19 08:13</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>When plotting in R and changing parameters via <code>par</code>, I have been very
careful about saving and restoring them:</p>
<pre class="code literal-block"><span></span>old <span class="o">&lt;-</span> par<span class="p">()</span>
par<span class="p">(</span>mar <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">7.1</span><span class="p">,</span> <span class="m">4.1</span><span class="p">,</span> <span class="m">4.1</span><span class="p">,</span> <span class="m">2.1</span><span class="p">))</span>
<span class="c1">## plot something, then restore:</span>
par<span class="p">(</span>old<span class="p">)</span>
</pre>


<p>If you do that as is, you will get several warnings when you call
<code>par(old)</code> about parameters that cannot be set. The way around that is
to pass the <code>no.readonly</code> flag:</p>
<pre class="code literal-block"><span></span>old <span class="o">&lt;-</span> par<span class="p">(</span>no.readonly <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="c1">## ...</span>
par<span class="p">(</span>old<span class="p">)</span>
</pre>


<p>If you are like me, you always call it the first way until you get the
warnings, then call it the second way and you get annoyed that you
have to type All That Extra Stuff.</p>
<p>One thing I learned this week is <code>par</code> returns a list of the old
parameters that you are setting. So for example,</p>
<pre class="code literal-block"><span></span>old <span class="o">&lt;-</span> par<span class="p">(</span>mar <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">7.1</span><span class="p">,</span> <span class="m">4.1</span><span class="p">,</span> <span class="m">4.1</span><span class="p">,</span> <span class="m">2.1</span><span class="p">))</span>
</pre>


<p><code>old</code> now only has one element named <code>mar</code> which has the old value in
it. Calling</p>
<pre class="code literal-block"><span></span>par<span class="p">(</span>old<span class="p">)</span>
</pre>


<p>now only resets that one value that was changed.</p>
<p>I've always thought the <code>par</code> function changed parameters per session.
The second thing I learned this week is the <code>par</code> function sets
parameters per device. That's not exactly a secret; the first line of
the Details section when you <code>?par</code> says</p>
<blockquote>
<p>Each device has its own set of graphical parameters.</p>
</blockquote>
<p>That means that to drop all parameter changes and go back to the
defaults, we can just call e.g.</p>
<pre class="code literal-block"><span></span>dev.new<span class="p">()</span>
</pre>


<p>or even <code>dev.off()</code>. No need to capture and restore anything.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/newtons-method/" class="u-url">Newton's Method</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Jeremiah Perry
            </span></p>
            <p class="dateline"><a href="posts/newtons-method/" rel="bookmark"><time class="published dt-published" datetime="2017-05-12T09:33:57-05:00" title="2017-05-12 09:33">2017-05-12 09:33</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div tabindex="-1" id="notebook" class="border-box-sizing">
    <div class="container" id="notebook-container">

<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Newton's-Method">Newton's Method<a class="anchor-link" href="posts/newtons-method/#Newton's-Method">¶</a>
</h2>
<p>After posting the <a href="posts/risk-parity-weights-in-r">R code for calculating risk parity weights</a>, I thought I should review Newton's method.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Univariate">Univariate<a class="anchor-link" href="posts/newtons-method/#Univariate">¶</a>
</h3>
<p>First, from the definition of a derivative for a function, we have</p>
<p>$\frac{f(x+h) - f(x)}{h} = f'(x) + E(x,h)$</p>
<p>Here $E$ is the error introduced by the approximation</p>
<p>$f(x+h) \approx f(x) + h f'(x)$</p>
<p>and if the derivative $f'(x)$ exists, $E$ must obey $ \lim_{h \to 0} E(x,h) = 0$.</p>
<p>Rearranging the equation gives</p>
<p>$f(x+h) = f(x) + hf'(x) + hE(x,h)$</p>
<p>This is a form of the first order Taylor polynomial. Since $E \rightarrow 0$ as $h \rightarrow 0$, $hE(x,h)$ is "small".</p>
<p>The goal is to find a zero, i.e. some $a$ such that $f(a) = 0$. Using the above and the smallness of $hE(x,h)$, a first order approximation for the zero will be to find $h$ such that $f(x+h) = 0$. Using that above we get</p>
<p>$0 = f(x) + hf'(x)$</p>
<p>Solving for $h$ gives</p>
<p>$h = -\frac{f(x)}{f'(x)}$</p>
<p>so our guess for the root $a = x+h$ is</p>
<p>$x - \frac{f(x)}{f'(x)}$</p>
<p>Making successive approximations yields a sequence</p>
<p>$x_{n+1} = x_n - \frac{f(x_n)}{f'(x_n)}$</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Multivariate">Multivariate<a class="anchor-link" href="posts/newtons-method/#Multivariate">¶</a>
</h3>
<p>The first order Taylor polynomial has a multivariate generalization:</p>
<p>$f(x+h) = f(x) + T_x(h) + \|h\| E(x,h)$</p>
<p>where $T_x(h)$ is the total derivative which is represented by the Jacobian matrix, a matrix where row $i$ and column $j$ is</p>
<p>$\frac{\partial f_i}{\partial x_j}$,</p>
<p>the partial derivative of the function $i$ with respect to variable $j$. We are dealing in higher dimensions now so $x$ and $h$ are vectors and $f$ is a function $\mathbb{R}^n \rightarrow \mathbb{R}^m$. We will be inverting the Jacobian so we will in fact need $n = m$.</p>
<p>Our first order approximation becomes</p>
<p>$0 = f(x) + J(x) \cdot h$</p>
<p>Solving for $h$ gives</p>
<p>$h = -[J(x)]^{-1} f(x)$</p>
<p>and so the guess for the roots become</p>
<p>$x - [J(x)]^{-1} f(x)$</p>
<p>As a sequence, we can write</p>
<p>$x_{n+1} = x_n - [J(x_n)]^{-1} f(x_n)$</p>
<p>This is the form of the solver used in the paper.</p>

</div>
</div>
</div>
    </div>
  </div>

    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/risk-parity-weights-in-r/" class="u-url">Risk Parity Weights in R</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Jeremiah Perry
            </span></p>
            <p class="dateline"><a href="posts/risk-parity-weights-in-r/" rel="bookmark"><time class="published dt-published" datetime="2017-05-05T13:50:55-05:00" title="2017-05-05 13:50">2017-05-05 13:50</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>Every now and then I need to calculate risk parity weights in R. I
like to know how things are working under the hood and the solutions I
found were a little opaque. Fortunately I found a nice article that
gives a straightforward algorithm,
see <a href="http://www.iinews.com/site/pdfs/joi_fall_2012_ra1.pdf">here</a>.</p>
<p>Here is my R code to implement it. This is from the "Algorithm 1:
Newton's method" section in the paper.</p>
<pre class="code literal-block"><span></span>riskparity <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>sigma<span class="p">,</span> tol <span class="o">=</span> <span class="m">1e-7</span><span class="p">,</span> maxeval <span class="o">=</span> <span class="m">1000</span><span class="p">)</span> <span class="p">{</span>
  <span class="bp">F</span> <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">,</span> lambda<span class="p">)</span> <span class="p">{</span>
    mat <span class="o">&lt;-</span> sigma <span class="o">%*%</span> x <span class="o">-</span> lambda <span class="o">*</span> <span class="m">1</span><span class="o">/</span>x
    <span class="kp">rbind</span><span class="p">(</span>mat<span class="p">,</span> <span class="kp">sum</span><span class="p">(</span>x<span class="p">)</span> <span class="o">-</span> <span class="m">1</span><span class="p">)</span>
  <span class="p">}</span>

  J <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>x<span class="p">,</span> lambda<span class="p">)</span> <span class="p">{</span>
    mat <span class="o">&lt;-</span> sigma <span class="o">+</span> lambda <span class="o">*</span> <span class="kp">diag</span><span class="p">(</span><span class="m">1</span><span class="o">/</span>x<span class="o">^</span><span class="m">2</span><span class="p">)</span>
    mat <span class="o">&lt;-</span> <span class="kp">rbind</span><span class="p">(</span>mat<span class="p">,</span> <span class="kp">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="kp">ncol</span><span class="p">(</span>sigma<span class="p">)))</span>
    <span class="kp">cbind</span><span class="p">(</span>mat<span class="p">,</span> <span class="kt">c</span><span class="p">(</span><span class="m">-1</span><span class="o">/</span>x<span class="p">,</span> <span class="m">0</span><span class="p">))</span>
  <span class="p">}</span>

  w <span class="o">&lt;-</span> <span class="m">1</span> <span class="o">/</span> <span class="kp">sqrt</span><span class="p">(</span><span class="kp">diag</span><span class="p">(</span>sigma<span class="p">))</span>
  w <span class="o">&lt;-</span> <span class="kt">c</span><span class="p">(</span>w <span class="o">/</span> <span class="kp">sum</span><span class="p">(</span>w<span class="p">),</span> <span class="m">0.5</span><span class="p">)</span> <span class="c1"># add guess for lambda at the end</span>
  N <span class="o">&lt;-</span> <span class="kp">length</span><span class="p">(</span>w<span class="p">)</span>

  cureval <span class="o">&lt;-</span> <span class="m">0</span>
  <span class="kr">while</span> <span class="p">(</span>cureval <span class="o">&lt;</span> maxeval<span class="p">)</span> <span class="p">{</span>
    cureval <span class="o">&lt;-</span> cureval <span class="o">+</span> <span class="m">1</span>
    wn <span class="o">&lt;-</span> w <span class="o">-</span> <span class="kp">solve</span><span class="p">(</span>J<span class="p">(</span>w<span class="p">[</span><span class="o">-</span>N<span class="p">],</span> w<span class="p">[</span>N<span class="p">]))</span> <span class="o">%*%</span> <span class="bp">F</span><span class="p">(</span>w<span class="p">[</span><span class="o">-</span>N<span class="p">],</span> w<span class="p">[</span>N<span class="p">])</span>
    <span class="kr">if</span> <span class="p">(</span><span class="kp">sqrt</span><span class="p">(</span><span class="kp">sum</span><span class="p">(</span>wn <span class="o">-</span> w<span class="p">)</span><span class="o">^</span><span class="m">2</span><span class="p">)</span> <span class="o">&lt;</span> tol<span class="p">)</span> <span class="p">{</span>
      <span class="kr">return</span><span class="p">(</span><span class="kt">list</span><span class="p">(</span>w <span class="o">=</span> w<span class="p">[</span><span class="o">-</span>N<span class="p">],</span> lambda <span class="o">=</span> w<span class="p">[</span>N<span class="p">],</span> status <span class="o">=</span> <span class="s">"converge"</span><span class="p">))</span>
    <span class="p">}</span>
    w <span class="o">&lt;-</span> wn
  <span class="p">}</span>

  <span class="kt">list</span><span class="p">(</span>w <span class="o">=</span> w<span class="p">[</span><span class="o">-</span>N<span class="p">],</span> lambda <span class="o">=</span> w<span class="p">[</span>N<span class="p">],</span> status <span class="o">=</span> <span class="s">"maxeval"</span><span class="p">)</span>
<span class="p">}</span>
</pre>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/reading-a-utf-8-csv-file-from-excel/" class="u-url">Reading a UTF-8 csv file from Excel</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Jeremiah Perry
            </span></p>
            <p class="dateline"><a href="posts/reading-a-utf-8-csv-file-from-excel/" rel="bookmark"><time class="published dt-published" datetime="2017-04-28T08:28:59-05:00" title="2017-04-28 08:28">2017-04-28 08:28</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>I recently upgraded to Windows 10 at work and the latest and greatest
version of Excel. I went to save a csv file to read into R and did not
realize I selected the "UTF-8" option.</p>
<p>When I read it into R, I saw three strange extra characters in the
first column name. No expert am I in unicode but I know enough to
recognize this was probably a byte-order mark and just needed to be
read differently.</p>
<p>I looked at the arg list for <code>read.csv</code> and tried the following:</p>
<pre class="code literal-block"><span></span>X <span class="o">&lt;-</span> read.csv<span class="p">(</span>filename<span class="p">,</span> encoding <span class="o">=</span> <span class="s">"utf-8"</span><span class="p">)</span>
</pre>


<p>This seemed very sensible to me since <code>encoding</code> is pretty standard
for this sort of thing in e.g. python. It did not work and when I
looked closer, I realized there was another argument, <code>fileEncoding</code>:</p>
<pre class="code literal-block"><span></span>X <span class="o">&lt;-</span> read.csv<span class="p">(</span>filename<span class="p">,</span> fileEncoding <span class="o">=</span> <span class="s">"utf-8"</span><span class="p">)</span>
</pre>


<p>Oddly, this did not work either. At this point I started mumbling
incoherently.</p>
<p>Naturally, Hadley came to my rescue when I read his answer to <a href="http://stackoverflow.com/questions/21624796/read-a-utf-8-text-file-with-bom">this
StackOverflow question</a>. 
Seems that in R, the correct "encoding" is "utf-8-bom" where bom
stands for byte order mark:</p>
<pre class="code literal-block"><span></span>X <span class="o">&lt;-</span> read.csv<span class="p">(</span>filename<span class="p">,</span> fileEncoding <span class="o">=</span> <span class="s">"utf-8-bom"</span><span class="p">)</span>
</pre>


<p>At last. Why do I have to use <code>fileEncoding</code> instead of just
<code>encoding</code>, and what does the <code>encoding</code> variable do anyway? Why do I
have to put "utf-8-bom" instead of just "utf-8"? Why does Excel feel
compelled to put a byte order mark in a UTF-8 file? If I were
industrious and curious, I would find out, but I am lazy and
uninterested so for now it will stay a mystery.</p>
</div>
    </div>
    </article><article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/consecutive-composite-numbers/" class="u-url">Consecutive Composite Numbers</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Jeremiah Perry
            </span></p>
            <p class="dateline"><a href="posts/consecutive-composite-numbers/" rel="bookmark"><time class="published dt-published" datetime="2017-04-20T12:57:07-05:00" title="2017-04-20 12:57">2017-04-20 12:57</time></a></p>
        </div>
    </header><div class="e-content entry-content">
    <div>
<p>I recently read that there exist strings of consecutive composite
numbers of arbitrary length. That hurts my head, just a little. So
even though there are infinitely many prime numbers, the gaps between
them can be arbitrarily long.</p>
<p>To generate a sequence of <code>n</code> numbers that are composite, take
<code>(n+1)! + 2</code>, <code>(n+1)! + 3</code>, ..., up to <code>(n+1)! + n+1</code>. That has <code>n</code>
numbers in it and each is composite: the first is divisible by 2, the
second is divisible by 3, etc.</p>
</div>
    </div>
    </article>
</div>





            <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"> </script><script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
    },
    displayAlign: 'left', // Change this to 'center' to center equations.
    "HTML-CSS": {
        styles: {'.MathJax_Display': {"margin": 0}}
    }
});
</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2017         <a href="mailto:">Jeremiah Perry</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
